package com.alibaba.laiwang.tide.share.business.excutor.wx.utils;

import android.graphics.Bitmap;
import android.graphics.BitmapFactory;

public class WeixinUtils {

	public static final int Type_Unknown = 0, Type_NONE = 1, Type_Session = 1, Type_Timeline = 2;

	/**
	 * 发送信息：4.0以上版本微信iPhone、Android客户端； 接收/查看信息：4.0以上版本微信iPhone、Android、Sybiam 客户端； 发送到朋友圈：4.2以上版本微信iPhone、Android客户端。
	 * 
	 * @param version
	 * @return
	 * @author lianbing.klb
	 */
	public int isSupportType(String version) {
		if (version == null || version.length() <= 2) {
			return Type_Unknown;
		}
		String[] codeArray = version.split(".");
		if (codeArray == null || codeArray.length < 2) {
			return Type_Unknown;
		}
		try {
			int mainCode = Integer.parseInt(codeArray[0]);
			int minCode = Integer.parseInt(codeArray[1]);
			if (mainCode < 4) {
				return Type_NONE;
			}
			if (minCode < 2) {
				return Type_Session;
			}
			return Type_Timeline;
		}
		catch (Exception e) {
			return Type_Unknown;
		}
	}

	public static String buildTransaction(final String type) {
		return (type == null) ? String.valueOf(System.currentTimeMillis()) : type + System.currentTimeMillis();
	}

	private static final int MAX_DECODE_PICTURE_SIZE = 1920 * 1440;

	static Bitmap extractThumbNail(final String path, final int height, final int width, final boolean crop) {
		BitmapFactory.Options options = new BitmapFactory.Options();

		try {
			options.inJustDecodeBounds = true;
			Bitmap tmp = BitmapFactory.decodeFile(path, options);
			if (tmp != null) {
				tmp.recycle();
				tmp = null;
			}

			final double beY = options.outHeight * 1.0 / height;
			final double beX = options.outWidth * 1.0 / width;
			options.inSampleSize = (int) (crop ? (beY > beX ? beX : beY) : (beY < beX ? beX : beY));
			if (options.inSampleSize <= 1) {
				options.inSampleSize = 1;
			}

			// NOTE: out of memory error
			while (options.outHeight * options.outWidth / options.inSampleSize > MAX_DECODE_PICTURE_SIZE) {
				options.inSampleSize++;
			}

			int newHeight = height;
			int newWidth = width;
			if (crop) {
				if (beY > beX) {
					newHeight = (int) (newWidth * 1.0 * options.outHeight / options.outWidth);
				}
				else {
					newWidth = (int) (newHeight * 1.0 * options.outWidth / options.outHeight);
				}
			}
			else {
				if (beY < beX) {
					newHeight = (int) (newWidth * 1.0 * options.outHeight / options.outWidth);
				}
				else {
					newWidth = (int) (newHeight * 1.0 * options.outWidth / options.outHeight);
				}
			}

			options.inJustDecodeBounds = false;

			Bitmap bm = BitmapFactory.decodeFile(path, options);
			if (bm == null) {
				return null;
			}

			final Bitmap scale = Bitmap.createScaledBitmap(bm, newWidth, newHeight, true);
			if (scale != null) {
				bm.recycle();
				bm = scale;
			}

			if (crop) {
				final Bitmap cropped = Bitmap.createBitmap(bm, (bm.getWidth() - width) >> 1,
						(bm.getHeight() - height) >> 1, width, height);
				if (cropped == null) {
					return bm;
				}

				bm.recycle();
				bm = cropped;
			}
			return bm;

		}
		catch (final OutOfMemoryError e) {
			options = null;
		}

		return null;
	}
}
